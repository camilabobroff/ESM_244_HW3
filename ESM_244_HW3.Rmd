---
title: "ESM_22_HW3"
author: "Camila Bobroff"
date: "3/2/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, inlcude=FALSE, message=FALSE, warning=FALSE}
#Part 0. Load packages
library(tidyverse)
library(tseries)
library(forecast)
library(sf)
library(tmap)
library(leaflet)
library(ggrepel)
library(ggspatial)
library(RColorBrewer)
library(raster)
library(naniar)
library(effsize)
```

####Task 1. Open science perspectives

#####600 - 800 word statement

####Task 2. Truckee River flow (2000 - 2016)

#####a) Graph with the decomposed time series information
```{r, message=FALSE, warning=FALSE}
# Get data
truckee <- read_csv("clean_truckee_flow.csv")

# Convert to ts data
truckee_ts <- ts(truckee$mean_va, frequency = 12, start = c(2000,1))
# plot(truckee_ts)

# Decompose to explore data further
truckee_dc <- decompose(truckee_ts)
plot(truckee_dc)
```
#####Although there are some high values and low values in the data, there do not seem to be any outliers (which could have a disproportionate effect on the time series model). There seems to be a slight downward trend in the data and it looks non-stationary and additive. We see a seasonal pattern that repeats about every 12 months and a slight cyclical trend about every five years (the seasonal component is on the same scale as the orinigal data).

#####b) Forecast the Truckee River for 5 years after the final observation in the dataset
```{r, message=FALSE, warning=FALSE}
# Holt Winters exponential smoothing
truckee_hw <- HoltWinters(truckee_ts)
# plot(truckee_hw)

# Forecast Holt Winters
truckee_forecast <- forecast(truckee_hw, h = 60)
# plot(truckee_forecast)

# Autoregressive integrated moving average (ARIMA) for comparison
# estimate pdq

truckee_pdq <- auto.arima(truckee_ts) # [2,1,1,][0,0,2]

# fit the ARIMA model
truckee_arima <- arima(truckee_ts, order = c(2,1,1), seasonal = list(order = c(0,0,2)))

# evaluate residuals
# par(mfrow = c(1,2))
# hist(truckee_arima$residuals)
# qqnorm(truckee_arima$residuals) # looks normal

# forecast ARIMA
forecast_truckee <- forecast(truckee_arima, h = 60)
# plot(forecast_truckee) 

# Graph of Holt Winters 
plot(truckee_forecast,
     xlab = "Time",
     ylab = "Truckee River Flows (cubic feet per second)")

```

#####c) Holt Winters residuals
```{r, message=FALSE, warning=FALSE}
par(mfrow = c(1,2))
hist(truckee_forecast$residuals) 
qqnorm(truckee_forecast$residuals) # Looks relatively normally distributed.
```

####Task 3. Mapping California's National Parks
```{r, message=FALSE, warning=FALSE}
# Read in nps data
nps_ca <- read_sf(dsn = ".", layer = "nps_boundary") %>%
  filter(STATE == "CA",
         UNIT_TYPE == "National Park") %>% 
  dplyr::select(UNIT_NAME) %>% 
  rename(Name = UNIT_NAME)

st_crs(nps_ca) = 4326

# Read in CA county data
ca_counties <- read_sf(dsn = ".", layer = "california_county_shape_file")

st_crs(ca_counties) = 4326

# Map it!
map_nps_ca <- tm_shape(nps_ca) +
  tm_fill("Name", palette = "Dark2", alpha = 0.5) +
  tm_shape(ca_counties) +
  tm_basemap("Esri.WorldPhysical") +
  tm_legend(show = FALSE) +
  tm_borders()

tmap_mode("view")

map_nps_ca
```

####Task 4. Lizards in the Northern Chihuahuan Desert
```{r, message=FALSE, warning=FALSE}
# Read in data and initial wrangling
lizard <- read_csv("clean_lizard.csv") %>% 
  filter(site == "CALI") %>% 
  replace_with_na_all(condition = ~.x == ".") %>% 
  filter(sex == "F" | sex == "M") %>% 
  drop_na(weight)

# Coerce weights to be numeric
lizard$weight <- as.numeric(lizard$weight)
```

#####a) For all lizards trapped at site ‘CALI’, do weights of male and female adult lizards differ significantly?
```{r, message=FALSE, warning=FALSE}
# Visualize data
# ggplot(lizard, aes(x = weight, fill = sex)) +
  # geom_histogram(alpha = 0.5, position = "identity")

# Both male and female weights are skewed. However, the central limit theorem applies here - distribution of means will be normally distributed (we have more than 30 observations in each group)

# Vector of adult male lizard weights
male <- lizard %>% 
  filter(sex == "M") %>% 
  pull(weight)

# Vector of adult female lizard weights
female <- lizard %>% 
  filter(sex == "F") %>% 
  pull(weight)

# F test for equal variance
# H0: Ratio of variances (Variance A/Variance B) = 1
# HA: Ratio of variances is NOT = 1

lizard_f <- var.test(female, male)
lizard_f
# p-value = 0.29, retain the null hypothesis of equal variance

# T sample t-test
# H0: Mean weights of adult female and male lizards are equal
# HA: Mean weights of adult female and male lizards are NOT equal

lizard_t <- t.test(female, male, var.equal = TRUE)
lizard_t
# p-value = 0.43, retain the null hypothesis. For lizards trapped at the CALI site, mean weights of female and male adult lizards do not differ significantly.

# Mean weights and Cohen's d - effect size
male_lizard <- lizard %>%
  dplyr::select(sex, weight) %>% 
  filter(sex == "M") 

female_lizard <- lizard %>% 
  dplyr::select(sex, weight) %>% 
  filter(sex == "F") 

male_mean <- mean(male_lizard$weight) # 4.96
male_sd <- sd(male_lizard$weight) # 5.68
female_mean <- mean(female_lizard$weight) # 6.50
female_sd <- sd(female_lizard$weight) #5.83

# Mean weight difference
mean_diff <- female_mean - male_mean # 0.86

effect_size <- cohen.d(weight ~ sex, data = lizard) 
# 0.14 neglibile

```


